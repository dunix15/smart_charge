<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.3/axios.min.js"></script>
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.js"></script>
    <style>
        .card-icon {
            font-size: 1.5rem; /* Increased from 1.25rem */
        }
        .is-bad {
            color: #ff3860;
        }
        .is-warning {
            color: #ffdd57;
        }
        .is-good {
            color: #23d160;
        }
        .toggle-label {
            cursor: pointer;
            font-size: 1rem; /* Increased from 0.75rem */
            margin-left: 0.5rem;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 50px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px; /* Increased from 12px */
            width: 14px; /* Increased from 12px */
            border-radius: 50px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #23d160;
        }
        input:checked + .slider:before {
            transform: translateX(14px);
        }
        .collapsible {
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
        .collapsible.closed {
            max-height: 0;
        }
        .section {
            padding: 1rem; /* Increased from 0.5rem */
        }
        .description {
            font-size: 1rem; /* Increased from 0.75rem */
            color: #7a7a7a;
        }
        .field:not(:last-child) {
            margin-bottom: 1rem; /* Increased from 0.5rem */
        }
        .switch-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem; /* Increased from 0.5rem */
        }
        .switch-container .switch {
            margin-right: 0.5rem;
        }
        .charging-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .charging-icon.is-charging {
            color: #23d160;
        }
        .charging-icon.is-not-charging {
            color: #ff3860;
        }
        .card-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 1rem;
        }
        .card-content p {
            margin: 0;
            font-size: 1rem;
        }
        .card-content .title {
            margin-bottom: 0.75rem;
        }
        .columns.is-inverted .column {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        @media (max-width: 768px) {
            .switch-container {
                flex-direction: row;
                align-items: center;
            }
        }
        .column.is-one-quarter {
            display: flex;
            justify-content: center;
        }
        .battery-progress-container {
            display: flex;
            align-items: center;
            font-size: 1.5rem; /* Ensure this matches the icon size */
        }

        .battery-progress {
            position: relative;
            width: 50px; /* Adjust width to align with icon size */
            height: 20px; /* Adjust height to align with icon size */
            background-color: #ccc;
            border-radius: 10px;
            margin-right: 0.5rem; /* Space between progress bar and percentage */
        }

        .battery-fill {
            height: 100%;
            background-color: #23d160; /* Color for filled portion of the bar */
            border-radius: 10px;
            transition: width 0.4s ease;
        }

        .battery-percentage {
            font-size: 1.5rem; /* Ensure this matches the icon size */
            color: #000; /* Adjust color as needed */
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- Header Note -->
        <section v-if="shouldIncreaseAutoConsumption" class="notification is-warning">
            <strong>Note:</strong> Increase auto-consumption
        </section>

        <!-- Available Power -->
        <section class="section">
            <h1 class="title is-4"> <!-- Increased from is-5 -->
                Available Power:
                <span v-if="this.state.available_power_kw !== undefined">{{ this.state.available_power_kw.toFixed(2) }} kW</span>
                <span v-else>Loading...</span>
            </h1>
        </section>

        <!-- Charging Status -->
        <section class="section">
            <div class="columns is-mobile is-vcentered">
                <div class="column has-text-centered">
                    <span :class="['charging-icon', state.is_charging ? 'is-charging' : 'is-not-charging']">
                        <i :class="['fas', state.is_charging ? 'fa-bolt' : 'fa-power-off']"></i>
                    </span>
                    <span><strong>{{ state.is_charging ? 'Charging' : 'Not Charging' }}</strong></span>
                </div>
                <div class="column has-text-centered">
                    <p>Amps: <strong v-if="state.amps !== undefined">{{ state.amps }}</strong><span v-else>Loading...</span></p>
                </div>
            </div>
        </section>

        <!-- Control Toggles -->
        <section class="section">
            <div class="columns is-mobile is-multiline">
                <div class="column has-text-centered">
                    <label class="switch">
                        <input type="checkbox" v-model="state.is_active" @change="updateState('is_active', state.is_active)">
                        <span class="slider"></span>
                    </label>
                    <span class="toggle-label">Is Active</span>
                </div>
                <div class="column has-text-centered">
                    <label class="switch">
                        <input type="checkbox" v-model="state.use_battery" @change="updateState('use_battery', state.use_battery)">
                        <span class="slider"></span>
                    </label>
                    <span class="toggle-label">Use Battery</span>
                </div>
            </div>
        </section>

        <!-- Inverter Data -->
        <section class="section">
            <div class="columns is-mobile is-multiline">
                <!-- PV Production  -->
                <div class="column is-half">
                    <div :class="['card', pvStatusClass]">
                        <div class="card-content">
                            <span class="card-icon"><i class="fas fa-solar-panel"></i></span>
                            <p class="title is-5"> <!-- Increased from is-6 -->
                                <span v-if="inverterData.production_kw !== undefined">{{ inverterData.production_kw.toFixed(2) }} kW</span>
                                <span v-else>Loading...</span>
                            </p>
                            <p class="description">{{ pvDescription }}</p>
                        </div>
                    </div>
                </div>

                <!-- Consumption -->
                <div class="column is-half">
                    <div :class="['card', consumptionStatusClass]">
                        <div class="card-content">
                            <span class="card-icon"><i class="fas fa-home"></i></span>
                            <p class="title is-5"> <!-- Increased from is-6 -->
                                <span v-if="inverterData.consumption_kw !== undefined">{{ inverterData.consumption_kw.toFixed(2) }} kW</span>
                                <span v-else>Loading...</span>
                            </p>
                            <p class="description">{{ consumptionDescription }}</p>
                        </div>
                    </div>
                </div>

                <!-- Battery Status -->
                <div class="column is-half">
                    <div :class="['card', batteryStatusClass]">
                        <div class="card-content">
                            <div class="battery-progress-container">
                                <div class="battery-progress">
                                    <div class="battery-fill" :style="{ width: batteryPercentage + '%' }"></div>
                                </div>
                                <span class="battery-percentage" v-if="inverterData.battery_soc !== undefined">
                                    {{ batteryPercentage }}%
                                </span>
                                <span v-else>Loading...</span>
                            </div>
                            <p class="title is-5">
                                <span v-if="batteryStatusText !== undefined">{{ batteryStatusText }}</span>
                                <span v-else>Loading...</span>
                            </p>
                            <p class="description">{{ batteryStatusDescription }}</p>
                        </div>
                    </div>
                </div>

                <!-- Net Import -->
                <div class="column is-half">
                    <div :class="['card', netImportStatusClass]">
                        <div class="card-content">
                            <span class="card-icon"><i class="fas fa-plug"></i></span>
                            <p class="title is-5"> <!-- Increased from is-6 -->
                                <span v-if="inverterData.net_import_kw !== undefined">{{ inverterData.net_import_kw.toFixed(2) }} kW</span>
                                <span v-else>Loading...</span>
                            </p>
                            <p class="description">{{ netImportDescription }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Advanced Settings -->
        <section class="section">
            <h2 class="subtitle is-5"> <!-- Increased from is-6 -->
                <a @click="toggleAdvancedSettings" style="cursor: pointer;">
                    Advanced Settings <i :class="['fas', advancedSettingsOpen ? 'fa-chevron-up' : 'fa-chevron-down']"></i>
                </a>
            </h2>
            <div :class="['collapsible', advancedSettingsClass]">
                <div class="field">
                    <label class="label">Inverter Max Power (kW)</label>
                    <input type="number" step="0.1" class="input" v-model="state.inverter_max_power_kw" @input="updateState('inverter_max_power_kw', state.inverter_max_power_kw)">
                </div>
                <div class="field">
                    <label class="label">Battery Max Power (kW)</label>
                    <input type="number" step="0.1" class="input" v-model="state.battery_max_power_kw" @input="updateState('battery_max_power_kw', state.battery_max_power_kw)">
                </div>
                <div class="field">
                    <label class="label">Battery Min SOC</label>
                    <input type="number" step="0.01" class="input" v-model="state.battery_min_soc" @input="updateState('battery_min_soc', state.battery_min_soc)">
                </div>
                <div class="field">
                    <label class="label">Voltage (V)</label>
                    <input type="number" class="input" v-model="state.voltage" @input="updateState('voltage', state.voltage)">
                </div>
            </div>
        </section>
    </div>

    <script>
        Vue.createApp({
            data() {
                return {
                    state: {},
                    inverterData: {},
                    advancedSettingsOpen: false
                };
            },
            computed: {
                batteryPercentage() {
                    if (this.inverterData.battery_soc !== undefined) {
                        return (this.inverterData.battery_soc * 100).toFixed(0);
                    }
                    return 0; // Default value or you could handle it as needed
                },
                shouldIncreaseAutoConsumption() {
                    return this.inverterData.production_kw > (this.inverterData.consumption_kw + 1);
                },
                pvStatusClass() {
                    return this.inverterData.production_kw > 0 ? 'is-good' : 'is-bad';
                },
                pvDescription() {
                    if (this.inverterData.production_kw !== undefined) {
                        return this.inverterData.production_kw > 0 ? 'Producing' : 'Not producing';
                    }
                    return 'Loading...';
                },
                netImportStatusClass() {
                    return this.inverterData.net_import_kw < 0.05 ? 'is-good' : (this.inverterData.net_import_kw > 0.1 ? 'is-bad' : 'is-warning');
                },
                batteryStatusClass() {
                    if (this.inverterData.battery_discharge_kw > 5) {
                        return 'is-bad';
                    } else if (this.inverterData.battery_discharge_kw > 4) {
                        return 'is-warning';
                    } else if (this.inverterData.battery_soc < 0.1 && this.inverterData.battery_discharge_kw > 0) {
                        return 'is-bad';
                    } else {
                        return 'is-good';
                    }
                },
                consumptionStatusClass() {
                    return this.inverterData.consumption_kw > Math.min(this.state.inverter_max_power_kw, this.inverterData.production_kw + this.state.battery_max_power_kw)
                        ? 'is-warning'
                        : 'is-good';
                },
                consumptionDescription() {
                    if (this.inverterData.consumption_kw !== undefined) {
                        return this.inverterData.consumption_kw > Math.min(this.state.inverter_max_power_kw, this.inverterData.production_kw + this.state.battery_max_power_kw)
                            ? 'High'
                            : 'Normal';
                    }
                    return 'Loading...';
                },
                batteryStatusText() {
                    return this.inverterData.battery_discharge_kw !== undefined
                        ? `${this.inverterData.battery_discharge_kw.toFixed(2)} kW`
                        : 'Loading...';
                },
                netImportDescription() {
                    if (this.inverterData.net_import_kw !== undefined) {
                        return Math.abs(this.inverterData.net_import_kw) < 0.05
                            ? 'Balanced'
                            : this.inverterData.net_import_kw > 0
                                ? 'Import'
                                : 'Export';
                    }
                    return 'Loading...';
                },
                batteryStatusDescription() {
                    if (this.inverterData.battery_discharge_kw !== undefined) {
                        if (this.inverterData.battery_discharge_kw > 0) {
                            return 'Discharging';
                        } else if (this.inverterData.battery_discharge_kw < 0) {
                            return 'Charging';
                        } else {
                            return `SOC: ${(this.inverterData.battery_soc * 100).toFixed(0)}%`;
                        }
                    }
                    return 'Loading...';
                },
                advancedSettingsClass() {
                    return this.advancedSettingsOpen ? 'open' : 'closed';
                }
            },
            methods: {
                fetchState() {
                    axios.get('/state').then(response => {
                        this.state = response.data;
                        this.inverterData = this.state.inverter_data;
                    });
                },
                updateState(field, value) {
                    const data = {};
                    data[field] = value;
                    axios.post('/state', data).then(response => {
                        this.state = response.data;
                    });
                },
                toggleAdvancedSettings() {
                    this.advancedSettingsOpen = !this.advancedSettingsOpen;
                }
            },
            mounted() {
                this.fetchState();
                setInterval(() => {
                    this.fetchState();
                }, 5000); // Update every 5 seconds
            }
        }).mount('#app');
    </script>
</body>
</html>
